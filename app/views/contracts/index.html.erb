<h1>Contracts</h1>

<%= form_with url: contracts_path, method: :get, class: "d-flex mb-3 position-relative", role: "search", data: { controller: "autocomplete", autocomplete_keywords_value: @query_keywords.to_json } do |form| %>
  <%= form.text_field :query, value: @query, placeholder: "Search...",
                       class: "form-control me-2", aria: { label: "Search" },
                       autocomplete: "off",
                       data: { autocomplete_target: "input", action: "input->autocomplete#filter keydown->autocomplete#navigate" } %>
  <div class="autocomplete-list position-absolute bg-white border shadow-sm top-100 w-100 d-none"
       data-autocomplete-target="suggestions"></div>
  <%= form.submit "Search", class: "btn btn-primary" %>
<% end %>

<p><%= link_to "Submit New Contract", new_contract_path, class: "btn btn-primary" %></p>

<% @contracts.each do |contract| %>
  <div class="contract border rounded p-3 mb-3 shadow-sm">
    <h2><%= contract.title %></h2>
    <% if current_user.admin? %>
      <small>Author: <%= contract.created_by.name %> &lt;<%=
        mail_to contract.created_by.email, subject: "Regarding contract '#{contract.title}'"
      %>&gt;</small>
    <% end %>
    <%= if contract.label
          # TODO: Light colors need black text. Needs helper for https://www.w3.org/TR/WCAG20/#contrast-ratiodef
          link_to content_tag(:span, contract.label.stamp,
            class: "badge",
            style: "background-color: #{contract.label.color}"
          ), "#"
        end %>
    <ul>
      <% contract.documents.each do |document| %>
        <li>
          <%= link_to url_for(document.file) do %>
            <%= document.title %>
            <br>
            <% if document.file.representable? %>
              <%= image_tag url_for(document.file.preview(resize_to_limit: [320, 240]).processed), class: "img-thumbnail mt-2" %>
            <% else %>
              View
            <% end %>
          <% end %>
        </li>
      <% end %>
    </ul>
    <%= link_to "View", contract_path(contract), class: "btn btn-secondary" %>
  </div>
<% end %>
